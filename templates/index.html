<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">
    <title>B2B Veri Toplayıcı</title>
    <style>
        :root {
            --primary-color: #FF7F00; /* Turuncu */
            --secondary-color: #0056b3; /* Mavi */
            --light-color: #f8f9fa; /* Beyaz */
            --dark-color: #343a40; /* Koyu gri */
        }
        
        body {
            padding: 40px;
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        .container {
            max-width: 800px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-top: 5px solid var(--primary-color);
        }
        
        h1 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .keyword-box {
            background-color: rgba(255, 127, 0, 0.1);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 127, 0, 0.3);
        }
        
        .keyword-item {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            padding: 5px 12px;
            margin: 5px;
            border-radius: 20px;
            border: none;
            transition: all 0.2s ease;
        }
        
        .keyword-item:hover {
            background-color: #003d7a;
        }
        
        .keyword-item .remove-keyword {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-keyword-btn {
            margin-top: 10px;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 127, 0, 0.25);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: #e67300;
            border-color: #e67300;
        }
        
        .btn-outline-secondary {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-secondary:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-success:hover {
            background-color: #003d7a;
            border-color: #003d7a;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 86, 179, 0.05);
        }
        
        .thead-dark {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .thead-dark th {
            background-color: var(--secondary-color) !important;
            border-color: var(--secondary-color) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">B2B Veri Toplayıcı</h1>
        <form id="search-form">
            <div class="form-group">
                <label>Arama Kelimeleri</label>
                <div id="keywords-container" class="keyword-box">
                    <!-- Arama kelimeleri buraya eklenecek -->
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="new-keyword" placeholder="Yeni arama kelimesi ekleyin">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" id="add-keyword-btn">Ekle</button>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="site-specifier">Site Belirteci</label>
                <input type="text" class="form-control" id="site-specifier" name="site-specifier" value="site:.myshopify.com" placeholder="Örn: site:.myshopify.com">
                <small class="form-text text-muted">Belirli bir site türünü aramak için kullanın (örn: site:.myshopify.com)</small>
            </div>
            
            <div class="form-group">
                <label>Ülke Seçimi</label>
                <div id="countries-container" class="keyword-box">
                    <!-- Seçilen ülkeler buraya eklenecek -->
                </div>
                <div class="input-group">
                    <select class="form-control" id="country-select">
                        <option value="">Ülke seçin...</option>
                        <option value="us">Amerika Birleşik Devletleri</option>
                        <option value="uk">Birleşik Krallık</option>
                        <option value="ca">Kanada</option>
                        <option value="au">Avustralya</option>
                        <option value="de">Almanya</option>
                        <option value="fr">Fransa</option>
                        <option value="it">İtalya</option>
                        <option value="es">İspanya</option>
                        <option value="nl">Hollanda</option>
                        <option value="tr">Türkiye</option>
                    </select>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" id="add-country-btn">Ekle</button>
                    </div>
                </div>
                <small class="form-text text-muted">Aramayı belirli ülkelerle sınırlandırmak için ülke seçin. Boş bırakırsanız tüm ülkelerde arama yapılır.</small>
            </div>
            
            <div class="form-group">
                <label for="sayi">Çekilecek Sonuç Sayısı</label>
                <input type="number" class="form-control" id="sayi" name="sayi" value="10" min="1" required>
                <small class="form-text text-muted">Seçtiğiniz ülkeye göre kesin sonuçlar getirilir. İstediğiniz sayıda sonuç alabilirsiniz.</small>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block">Aramayı Başlat</button>
        </form>
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Yükleniyor...</span>
            </div>
            <p class="mt-2">Veriler toplanıyor, lütfen bekleyin...</p>
        </div>
        <div id="results" class="mt-5"></div>
    </div>

    <script>
        // Varsayılan arama kelimeleri
        const defaultKeywords = ["wholesale clothing", "B2B fashion"];
        const keywordsContainer = document.getElementById('keywords-container');
        const newKeywordInput = document.getElementById('new-keyword');
        const addKeywordBtn = document.getElementById('add-keyword-btn');
        const siteSpecifierInput = document.getElementById('site-specifier');
        
        // Ülke seçimi için değişkenler
        const countriesContainer = document.getElementById('countries-container');
        const countrySelect = document.getElementById('country-select');
        const addCountryBtn = document.getElementById('add-country-btn');
        
        // Ülke kodu ve adı eşleştirme
        const countryNames = {
            'us': 'Amerika Birleşik Devletleri',
            'uk': 'Birleşik Krallık',
            'ca': 'Kanada',
            'au': 'Avustralya',
            'de': 'Almanya',
            'fr': 'Fransa',
            'it': 'İtalya',
            'es': 'İspanya',
            'nl': 'Hollanda',
            'tr': 'Türkiye'
        };
        
        // Arama kelimelerini ekle
        function addKeyword(keyword) {
            if (keyword.trim() === '') return;
            
            const keywordElement = document.createElement('span');
            keywordElement.className = 'keyword-item';
            keywordElement.innerHTML = `
                ${keyword}
                <span class="remove-keyword">&times;</span>
            `;
            
            keywordElement.querySelector('.remove-keyword').addEventListener('click', function() {
                keywordsContainer.removeChild(keywordElement);
            });
            
            keywordsContainer.appendChild(keywordElement);
            newKeywordInput.value = '';
        }
        
        // Ülke ekle
        function addCountry(countryCode) {
            if (countryCode === '') return;
            
            // Aynı ülke zaten eklenmişse tekrar ekleme
            const existingCountries = document.querySelectorAll('.country-item');
            for (let i = 0; i < existingCountries.length; i++) {
                if (existingCountries[i].dataset.code === countryCode) {
                    return;
                }
            }
            
            const countryElement = document.createElement('span');
            countryElement.className = 'keyword-item country-item';
            countryElement.dataset.code = countryCode;
            countryElement.innerHTML = `
                ${countryNames[countryCode]}
                <span class="remove-keyword">&times;</span>
            `;
            
            countryElement.querySelector('.remove-keyword').addEventListener('click', function() {
                countriesContainer.removeChild(countryElement);
            });
            
            countriesContainer.appendChild(countryElement);
            countrySelect.value = '';
        }
        
        // Varsayılan kelimeleri ekle
        defaultKeywords.forEach(keyword => addKeyword(keyword));
        
        // Yeni kelime ekleme butonu
        addKeywordBtn.addEventListener('click', function() {
            addKeyword(newKeywordInput.value);
        });
        
        // Ülke ekleme butonu
        addCountryBtn.addEventListener('click', function() {
            addCountry(countrySelect.value);
        });
        
        // Enter tuşu ile kelime ekleme
        newKeywordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addKeyword(newKeywordInput.value);
            }
        });
        
        // Ülke seçiminde değişiklik olduğunda otomatik ekle
        countrySelect.addEventListener('change', function() {
            if (countrySelect.value !== '') {
                addCountry(countrySelect.value);
            }
        });
        
        // Form gönderildiğinde
        document.getElementById('search-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Arama kelimelerini topla
            const keywords = [];
            document.querySelectorAll('.keyword-item:not(.country-item)').forEach(item => {
                keywords.push(item.textContent.trim().replace('×', ''));
            });
            
            // Ülkeleri topla
            const countries = [];
            document.querySelectorAll('.country-item').forEach(item => {
                countries.push(item.dataset.code);
            });
            
            // Arama sorgusunu oluştur
            const siteSpecifier = siteSpecifierInput.value.trim();
            let searchQuery = keywords.map(k => `"${k}"`).join(' OR ');
            if (siteSpecifier) {
                searchQuery += ` ${siteSpecifier}`;
            }
            
            const data = {
                sorgu: searchQuery,
                sayi: document.getElementById('sayi').value,
                ulkeler: countries
            };
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';

            const response = await fetch('/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const results = await response.json();
            document.getElementById('loading').style.display = 'none';

            if (results.error) {
                let errorMessage = `<div class="alert alert-danger">`;
                errorMessage += `<h4 class="alert-heading"><strong>${results.error}</strong></h4>`;
                if (results.message) {
                    errorMessage += `<p>${results.message}</p>`;
                }
                
                // Google rate limiting hatası için özel öneri
                if (results.error.includes("web sitesi bulunamadı") || (results.message && results.message.includes("Google arama sınırlaması"))) {
                    errorMessage += `<hr>`;
                    errorMessage += `<p><strong>Öneriler:</strong></p>`;
                    errorMessage += `<ul>`;
                    errorMessage += `<li>Sonuç sayısını azaltın (5-10 arası bir değer deneyin)</li>`;
                    errorMessage += `<li>Birkaç saat bekleyip tekrar deneyin</li>`;
                    errorMessage += `<li>Arama sorgusunu basitleştirin</li>`;
                    errorMessage += `<li>Farklı anahtar kelimeler kullanın</li>`;
                    errorMessage += `</ul>`;
                }
                
                errorMessage += `<div class="mt-3">`;
                errorMessage += `<button class="btn btn-warning mr-2" onclick="window.location.reload()">Tekrar Dene</button>`;
                errorMessage += `<button class="btn btn-outline-secondary" onclick="document.getElementById('sayi').value='5'; document.getElementById('search-form').dispatchEvent(new Event('submit'))">5 Sonuç İle Dene</button>`;
                errorMessage += `</div>`;
                errorMessage += `</div>`;
                document.getElementById('results').innerHTML = errorMessage;
            } else {
                let table = '<h2 class="text-center" style="color: #FF7F00;">Sonuçlar</h2>';
                table += `<p class="text-center"><a href="/download" class="btn btn-success">CSV Olarak İndir</a></p>`;
                table += '<table class="table table-striped mt-4">';
                table += '<thead class="thead-dark"><tr><th>Firma Adı</th><th>Web Sitesi</th><th>Bulunan E-postalar</th></tr></thead>';
                table += '<tbody>';
                results.forEach(row => {
                    table += `<tr><td>${row['Firma Adı']}</td><td>${row['Web Sitesi']}</td><td>${row['Bulunan E-postalar']}</td></tr>`;
                });
                table += '</tbody></table>';
                document.getElementById('results').innerHTML = table;
            }
        });
    </script>
</body>
</html>