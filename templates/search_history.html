{% extends "base_saas.html" %}

{% block title %}Arama Geçmişi - B2B Veri{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-1">Arama Geçmişi</h2>
                    <p class="text-muted mb-0">Geçmiş aramalarınızı görüntüleyin ve yeniden çalıştırın</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-danger" id="clearAllBtn" 
                            {% if not search_history %}disabled{% endif %}>
                        <i class="fas fa-trash me-2"></i>Tümünü Temizle
                    </button>
                    <a href="{{ url_for('main.search') }}" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Yeni Arama
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Search History Content -->
    {% if search_history %}
    <div class="row">
        <div class="col-12">
            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3">
                            <label for="filterDate" class="form-label fw-medium">Tarih Aralığı</label>
                            <select class="form-select" id="filterDate">
                                <option value="all">Tüm Zamanlar</option>
                                <option value="today">Bugün</option>
                                <option value="week">Son 7 Gün</option>
                                <option value="month">Son 30 Gün</option>
                                <option value="custom">Özel Tarih</option>
                            </select>
                        </div>
                        <div class="col-lg-3">
                            <label for="filterQuery" class="form-label fw-medium">Arama Terimi</label>
                            <input type="text" class="form-control" id="filterQuery" 
                                   placeholder="Arama teriminde filtrele...">
                        </div>
                        <div class="col-lg-3">
                            <label for="filterLocation" class="form-label fw-medium">Konum</label>
                            <select class="form-select" id="filterLocation">
                                <option value="all">Tüm Konumlar</option>
                                <option value="Turkey">Türkiye</option>
                                <option value="Istanbul, Turkey">İstanbul</option>
                                <option value="Ankara, Turkey">Ankara</option>
                                <option value="Izmir, Turkey">İzmir</option>
                            </select>
                        </div>
                        <div class="col-lg-3">
                            <label for="filterSort" class="form-label fw-medium">Sıralama</label>
                            <select class="form-select" id="filterSort">
                                <option value="date_desc">En Yeni</option>
                                <option value="date_asc">En Eski</option>
                                <option value="query_asc">A-Z</option>
                                <option value="results_desc">Sonuç Sayısı</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Custom Date Range (Hidden by default) -->
                    <div class="row mt-3 d-none" id="customDateRange">
                        <div class="col-lg-3">
                            <label for="startDate" class="form-label fw-medium">Başlangıç</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-lg-3">
                            <label for="endDate" class="form-label fw-medium">Bitiş</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-lg-3 d-flex align-items-end">
                            <button type="button" class="btn btn-primary" id="applyDateFilter">
                                <i class="fas fa-filter me-2"></i>Uygula
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search History List -->
            <div id="historyList">
                {% for history in search_history %}
                <div class="card border-0 shadow-sm mb-3 history-item" 
                     data-date="{{ history.created_at.strftime('%Y-%m-%d') }}"
                     data-query="{{ history.query.lower() }}"
                     data-location="{{ history.location or 'Turkey' }}"
                     data-results="{{ history.result_count or 0 }}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-lg-8">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px;">
                                            <i class="fas fa-search text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-1">{{ history.query }}</h6>
                                        
                                        <div class="d-flex flex-wrap gap-3 text-muted small mb-2">
                                            <span>
                                                <i class="fas fa-calendar me-1"></i>
                                                {{ history.created_at.strftime('%d.%m.%Y %H:%M') }}
                                            </span>
                                            
                                            {% if history.location and history.location != 'Turkey' %}
                                            <span>
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ history.location }}
                                            </span>
                                            {% endif %}
                                            
                                            {% if history.result_count is not none %}
                                            <span>
                                                <i class="fas fa-list me-1"></i>
                                                {{ history.result_count }} sonuç
                                            </span>
                                            {% endif %}
                                            
                                            {% if history.export_count and history.export_count > 0 %}
                                            <span>
                                                <i class="fas fa-download me-1"></i>
                                                {{ history.export_count }} dışa aktarım
                                            </span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Search Parameters -->
                                        {% if history.filters %}
                                        <div class="mb-2">
                                            {% if history.filters.get('category') %}
                                                <span class="badge bg-light text-dark me-1">
                                                    <i class="fas fa-tag me-1"></i>{{ history.filters.category.title() }}
                                                </span>
                                            {% endif %}
                                            {% if history.filters.get('rating') %}
                                                <span class="badge bg-light text-dark me-1">
                                                    <i class="fas fa-star me-1"></i>{{ history.filters.rating }}+ Yıldız
                                                </span>
                                            {% endif %}
                                            {% if history.filters.get('price_level') %}
                                                <span class="badge bg-light text-dark me-1">
                                                    <i class="fas fa-dollar-sign me-1"></i>
                                                    {% for i in range(history.filters.price_level|int) %}${% endfor %}
                                                </span>
                                            {% endif %}
                                            {% if history.filters.get('open_now') %}
                                                <span class="badge bg-success text-white me-1">
                                                    <i class="fas fa-clock me-1"></i>Şu anda açık
                                                </span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Success/Error Status -->
                                        {% if history.status == 'completed' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Başarılı
                                            </span>
                                        {% elif history.status == 'error' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Hata
                                            </span>
                                        {% elif history.status == 'no_results' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-info-circle me-1"></i>Sonuç Yok
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="text-end">
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('main.search', q=history.query, location=history.location, num=history.num) }}{% if history.filters %}{% for key, value in history.filters.items() %}&{{ key }}={{ value }}{% endfor %}{% endif %}" 
                                           class="btn btn-primary btn-sm">
                                            <i class="fas fa-redo me-1"></i>Tekrar Ara
                                        </a>
                                        
                                        {% if history.result_count and history.result_count > 0 %}
                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                onclick="exportHistory('{{ history.id }}')">
                                            <i class="fas fa-download me-1"></i>Dışa Aktar
                                        </button>
                                        {% endif %}
                                        
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                                    data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item" href="#" 
                                                       onclick="favoriteSearch('{{ history.id }}', '{{ history.query }}')">
                                                        <i class="fas fa-heart me-2"></i>Favorile
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#" 
                                                       onclick="shareSearch('{{ history.query }}', '{{ history.location }}')">
                                                        <i class="fas fa-share me-2"></i>Paylaş
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#" 
                                                       onclick="deleteHistory('{{ history.id }}')">
                                                        <i class="fas fa-trash me-2"></i>Sil
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expandable Details -->
                        {% if history.error_message or (history.execution_time and history.execution_time > 0) %}
                        <div class="mt-3">
                            <button class="btn btn-link p-0 text-decoration-none small" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#historyDetails{{ loop.index }}">
                                <i class="fas fa-chevron-down me-1"></i>Detayları Gör
                            </button>
                            
                            <div class="collapse" id="historyDetails{{ loop.index }}">
                                <div class="mt-2 p-3 bg-light rounded">
                                    {% if history.execution_time and history.execution_time > 0 %}
                                    <div class="mb-2">
                                        <strong>Çalışma Süresi:</strong> {{ "%.2f"|format(history.execution_time) }} saniye
                                    </div>
                                    {% endif %}
                                    
                                    {% if history.api_calls_used %}
                                    <div class="mb-2">
                                        <strong>API Çağrısı:</strong> {{ history.api_calls_used }} adet
                                    </div>
                                    {% endif %}
                                    
                                    {% if history.error_message %}
                                    <div class="mb-2">
                                        <strong>Hata Mesajı:</strong>
                                        <div class="text-danger small mt-1">{{ history.error_message }}</div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if history.user_agent %}
                                    <div class="mb-2">
                                        <strong>Cihaz:</strong> 
                                        <small class="text-muted">{{ history.user_agent[:100] }}{% if history.user_agent|length > 100 %}...{% endif %}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if pagination and pagination.pages > 1 %}
            <nav aria-label="Arama geçmişi sayfalama">
                <ul class="pagination justify-content-center">
                    {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.search_history', page=pagination.prev_num) }}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for page_num in pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('main.search_history', page=page_num) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.search_history', page=pagination.next_num) }}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
    
    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-history text-muted mb-3" style="font-size: 4rem;"></i>
                    <h4 class="text-muted mb-3">Henüz Arama Yapmadınız</h4>
                    <p class="text-muted mb-4">
                        Arama geçmişiniz burada görünecek. İlk aramanızı yapmak için aşağıdaki butona tıklayın.
                    </p>
                    
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3">Arama Geçmişi Avantajları:</h6>
                                    <ul class="list-unstyled text-start">
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Geçmiş aramalarınızı tekrar çalıştırın</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Arama sonuçlarını dışa aktarın</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Favori aramalarınızı kaydedin</li>
                                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Arama istatistiklerinizi görün</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <a href="{{ url_for('main.search') }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-search me-2"></i>İlk Aramanızı Yapın
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Arama Geçmişini Sil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bu arama kaydını silmek istediğinizden emin misiniz?</p>
                <p class="text-muted small">Bu işlem geri alınamaz.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash me-2"></i>Sil
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clear All Confirmation Modal -->
<div class="modal fade" id="clearAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tüm Geçmişi Temizle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tüm arama geçmişinizi silmek istediğinizden emin misiniz?</p>
                <p class="text-danger small"><strong>Uyarı:</strong> Bu işlem geri alınamaz ve tüm arama kayıtlarınız silinecek.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmClearAll">
                    <i class="fas fa-trash me-2"></i>Tümünü Sil
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let deleteHistoryId = null;
    
    // Filter functionality
    $('#filterDate, #filterQuery, #filterLocation, #filterSort').on('change input', function() {
        filterHistory();
    });
    
    // Custom date range toggle
    $('#filterDate').on('change', function() {
        if ($(this).val() === 'custom') {
            $('#customDateRange').removeClass('d-none');
        } else {
            $('#customDateRange').addClass('d-none');
            filterHistory();
        }
    });
    
    // Apply custom date filter
    $('#applyDateFilter').on('click', function() {
        filterHistory();
    });
    
    // Clear all history
    $('#clearAllBtn').on('click', function() {
        $('#clearAllModal').modal('show');
    });
    
    $('#confirmClearAll').on('click', function() {
        $.ajax({
            url: '{{ url_for("main.clear_search_history") }}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    showToast('Hata: ' + response.message, 'error');
                }
            },
            error: function() {
                showToast('Bir hata oluştu.', 'error');
            }
        });
        
        $('#clearAllModal').modal('hide');
    });
    
    // Delete confirmation
    $('#confirmDelete').on('click', function() {
        if (deleteHistoryId) {
            $.ajax({
                url: '{{ url_for("main.delete_search_history") }}',
                method: 'POST',
                data: {
                    'history_id': deleteHistoryId
                },
                headers: {
                    'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
                },
                success: function(response) {
                    if (response.success) {
                        $(`.history-item[data-id="${deleteHistoryId}"]`).fadeOut(300, function() {
                            $(this).remove();
                            
                            // Check if no items left
                            if ($('.history-item').length === 0) {
                                location.reload();
                            }
                        });
                        showToast('Arama geçmişi silindi.', 'success');
                    } else {
                        showToast('Hata: ' + response.message, 'error');
                    }
                },
                error: function() {
                    showToast('Bir hata oluştu.', 'error');
                }
            });
        }
        
        $('#deleteModal').modal('hide');
        deleteHistoryId = null;
    });
});

// Helper functions
function filterHistory() {
    const dateFilter = $('#filterDate').val();
    const queryFilter = $('#filterQuery').val().toLowerCase();
    const locationFilter = $('#filterLocation').val();
    const sortFilter = $('#filterSort').val();
    
    let items = $('.history-item').get();
    
    // Filter items
    items = items.filter(function(item) {
        const $item = $(item);
        const itemDate = $item.data('date');
        const itemQuery = $item.data('query');
        const itemLocation = $item.data('location');
        
        // Date filter
        if (dateFilter !== 'all') {
            const today = new Date();
            const itemDateObj = new Date(itemDate);
            
            switch(dateFilter) {
                case 'today':
                    if (itemDateObj.toDateString() !== today.toDateString()) return false;
                    break;
                case 'week':
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (itemDateObj < weekAgo) return false;
                    break;
                case 'month':
                    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (itemDateObj < monthAgo) return false;
                    break;
                case 'custom':
                    const startDate = $('#startDate').val();
                    const endDate = $('#endDate').val();
                    if (startDate && itemDate < startDate) return false;
                    if (endDate && itemDate > endDate) return false;
                    break;
            }
        }
        
        // Query filter
        if (queryFilter && !itemQuery.includes(queryFilter)) return false;
        
        // Location filter
        if (locationFilter !== 'all' && itemLocation !== locationFilter) return false;
        
        return true;
    });
    
    // Sort items
    items.sort(function(a, b) {
        const $a = $(a);
        const $b = $(b);
        
        switch(sortFilter) {
            case 'date_asc':
                return $a.data('date').localeCompare($b.data('date'));
            case 'date_desc':
                return $b.data('date').localeCompare($a.data('date'));
            case 'query_asc':
                return $a.data('query').localeCompare($b.data('query'));
            case 'results_desc':
                return $b.data('results') - $a.data('results');
            default:
                return 0;
        }
    });
    
    // Hide all items first
    $('.history-item').hide();
    
    // Show filtered and sorted items
    $.each(items, function(index, item) {
        $(item).show();
        $('#historyList').append(item);
    });
    
    // Show no results message if needed
    if (items.length === 0) {
        if ($('#noResultsMessage').length === 0) {
            $('#historyList').append(`
                <div id="noResultsMessage" class="text-center py-5">
                    <i class="fas fa-search text-muted mb-3" style="font-size: 3rem;"></i>
                    <h5 class="text-muted">Filtrelere uygun sonuç bulunamadı</h5>
                    <p class="text-muted">Farklı filtreler deneyebilirsiniz.</p>
                </div>
            `);
        }
    } else {
        $('#noResultsMessage').remove();
    }
}

function deleteHistory(historyId) {
    deleteHistoryId = historyId;
    $('#deleteModal').modal('show');
}

function exportHistory(historyId) {
    window.location.href = '{{ url_for("main.export_history") }}?history_id=' + historyId;
    showToast('Dışa aktarım başlatıldı.', 'success');
}

function favoriteSearch(historyId, query) {
    // Implementation for favoriting search
    showToast('"' + query + '" favorilere eklendi.', 'success');
}

function shareSearch(query, location) {
    const url = '{{ url_for("main.search") }}?q=' + encodeURIComponent(query) + 
                (location && location !== 'Turkey' ? '&location=' + encodeURIComponent(location) : '');
    
    if (navigator.share) {
        navigator.share({
            title: 'B2B Veri Arama: ' + query,
            text: query + ' araması',
            url: window.location.origin + url
        });
    } else {
        // Fallback: copy to clipboard
        const text = 'B2B Veri Arama: ' + query + '\n' + window.location.origin + url;
        navigator.clipboard.writeText(text).then(function() {
            showToast('Arama linki panoya kopyalandı.', 'success');
        });
    }
}
</script>
{% endblock %}