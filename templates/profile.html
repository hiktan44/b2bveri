{% extends "base_saas.html" %}

{% block title %}Profil - B2B Veri{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Profile Sidebar -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="avatar-lg mx-auto mb-3">
                            {% if current_user.avatar %}
                                <img src="{{ current_user.avatar }}" alt="Avatar" class="rounded-circle" width="80" height="80">
                            {% else %}
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                    <span class="text-white fw-bold" style="font-size: 2rem;">
                                        {{ current_user.name[0].upper() if current_user.name else 'U' }}
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                        <h5 class="fw-bold mb-1">{{ current_user.name or 'Kullanıcı' }}</h5>
                        <p class="text-muted mb-0">{{ current_user.email }}</p>
                        <span class="badge bg-secondary mt-2" id="subscriptionBadge">
                                                            Free
                                                        </span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#avatarModal">
                            <i class="fas fa-camera me-2"></i>Fotoğraf Değiştir
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-white border-0">
                    <h6 class="fw-bold mb-0">Hesap İstatistikleri</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 fw-bold text-primary mb-1">{{ current_user.search_count or 0 }}</div>
                                <small class="text-muted">Toplam Arama</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 fw-bold text-success mb-1">{{ current_user.api_usage or 0 }}</div>
                                <small class="text-muted">API Kullanımı</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="text-center">
                                <div class="h6 fw-bold text-info mb-1">
                                    {{ current_user.created_at.strftime('%d.%m.%Y') if current_user.created_at else 'Bilinmiyor' }}
                                </div>
                                <small class="text-muted">Üyelik Tarihi</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <!-- Profile Tabs -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <ul class="nav nav-tabs card-header-tabs" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                                <i class="fas fa-user me-2"></i>Genel Bilgiler
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                                <i class="fas fa-shield-alt me-2"></i>Güvenlik
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="subscription-tab" data-bs-toggle="tab" data-bs-target="#subscription" type="button" role="tab">
                                <i class="fas fa-credit-card me-2"></i>Abonelik
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab">
                                <i class="fas fa-code me-2"></i>API Anahtarları
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
                                <i class="fas fa-bell me-2"></i>Bildirimler
                            </button>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body">
                    <div class="tab-content" id="profileTabsContent">
                        <!-- General Information Tab -->
                        <div class="tab-pane fade show active" id="general" role="tabpanel">
                            <form id="profileForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="name" class="form-label">Ad Soyad *</label>
                                        <input type="text" class="form-control" id="name" value="{{ current_user.name or '' }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="email" class="form-label">E-posta *</label>
                                        <input type="email" class="form-control" id="email" value="{{ current_user.email }}" required>
                                        {% if not current_user.email_verified %}
                                            <div class="form-text text-warning">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                E-posta adresiniz doğrulanmamış. 
                                                <a href="#" id="resendVerification">Doğrulama e-postası gönder</a>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="phone" class="form-label">Telefon</label>
                                        <input type="tel" class="form-control" id="phone" value="{{ current_user.phone or '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="company" class="form-label">Şirket</label>
                                        <input type="text" class="form-control" id="company" value="{{ current_user.company or '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="title" class="form-label">Ünvan</label>
                                        <input type="text" class="form-control" id="title" value="{{ current_user.title or '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="industry" class="form-label">Sektör</label>
                                        <select class="form-select" id="industry">
                                            <option value="">Seçiniz</option>
                                            <option value="technology" {{ 'selected' if current_user.industry == 'technology' else '' }}>Teknoloji</option>
                                            <option value="finance" {{ 'selected' if current_user.industry == 'finance' else '' }}>Finans</option>
                                            <option value="healthcare" {{ 'selected' if current_user.industry == 'healthcare' else '' }}>Sağlık</option>
                                            <option value="education" {{ 'selected' if current_user.industry == 'education' else '' }}>Eğitim</option>
                                            <option value="retail" {{ 'selected' if current_user.industry == 'retail' else '' }}>Perakende</option>
                                            <option value="manufacturing" {{ 'selected' if current_user.industry == 'manufacturing' else '' }}>İmalat</option>
                                            <option value="consulting" {{ 'selected' if current_user.industry == 'consulting' else '' }}>Danışmanlık</option>
                                            <option value="other" {{ 'selected' if current_user.industry == 'other' else '' }}>Diğer</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label for="bio" class="form-label">Hakkında</label>
                                        <textarea class="form-control" id="bio" rows="3" placeholder="Kendiniz hakkında kısa bilgi...">{{ current_user.bio or '' }}</textarea>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Değişiklikleri Kaydet
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" id="resetForm">
                                        <i class="fas fa-undo me-2"></i>Sıfırla
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Security Tab -->
                        <div class="tab-pane fade" id="security" role="tabpanel">
                            <div class="row g-4">
                                <!-- Change Password -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="fw-bold mb-3">Şifre Değiştir</h6>
                                            <form id="passwordForm">
                                                <div class="row g-3">
                                                    <div class="col-12">
                                                        <label for="currentPassword" class="form-label">Mevcut Şifre</label>
                                                        <input type="password" class="form-control" id="currentPassword" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="newPassword" class="form-label">Yeni Şifre</label>
                                                        <input type="password" class="form-control" id="newPassword" required>
                                                        <div class="form-text">En az 8 karakter, büyük/küçük harf ve rakam içermeli</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="confirmPassword" class="form-label">Yeni Şifre (Tekrar)</label>
                                                        <input type="password" class="form-control" id="confirmPassword" required>
                                                    </div>
                                                </div>
                                                <div class="mt-3">
                                                    <button type="submit" class="btn btn-warning">
                                                        <i class="fas fa-key me-2"></i>Şifreyi Değiştir
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Two-Factor Authentication -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="fw-bold mb-2">İki Faktörlü Kimlik Doğrulama</h6>
                                                    <p class="text-muted mb-0">Hesabınızın güvenliğini artırmak için 2FA'yı etkinleştirin</p>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="twoFactorToggle" 
                                                           {{ 'checked' if current_user.two_factor_enabled else '' }}>
                                                    <label class="form-check-label" for="twoFactorToggle"></label>
                                                </div>
                                            </div>
                                            
                                            <div id="twoFactorSetup" class="mt-3" style="display: {{ 'block' if current_user.two_factor_enabled else 'none' }};">
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    Google Authenticator veya benzeri bir uygulama kullanarak QR kodu tarayın.
                                                </div>
                                                <div class="text-center">
                                                    <div id="qrCode" class="mb-3"></div>
                                                    <p class="small text-muted">QR kod yüklenemiyorsa bu kodu manuel olarak girin:</p>
                                                    <code id="manualCode">{{ current_user.two_factor_secret or '' }}</code>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Login Sessions -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="fw-bold mb-0">Aktif Oturumlar</h6>
                                                <button type="button" class="btn btn-outline-danger btn-sm" id="logoutAllSessions">
                                                    <i class="fas fa-sign-out-alt me-2"></i>Tüm Oturumları Sonlandır
                                                </button>
                                            </div>
                                            
                                            <div id="sessionsList">
                                                <!-- Sessions will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Subscription Tab -->
                        <div class="tab-pane fade" id="subscription" role="tabpanel">
                            <div class="row g-4">
                                <!-- Current Plan -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="fw-bold mb-2">Mevcut Planınız</h6>
                                                    <div class="d-flex align-items-center gap-2 mb-2">
                                                        <span class="badge bg-secondary fs-6" id="currentPlanBadge">
                                                            Free
                                                        </span>
                                                        <span class="badge bg-success" id="subscriptionStatus">Aktif</span>
                                                    </div>
                                                    <p class="text-muted mb-0" id="subscriptionDate">
                                                        Yenileme tarihi: --
                                                    </p>
                                                </div>
                                                <div class="text-end">
                                                    {% if current_user.subscription_plan != 'free' %}
                                                        <div class="h5 fw-bold text-primary mb-1">
                                                            ₺{{ current_user.subscription_amount or 0 }}
                                                        </div>
                                                        <small class="text-muted">/{{ 'yıl' if current_user.subscription_interval == 'year' else 'ay' }}</small>
                                                    {% else %}
                                                        <div class="h5 fw-bold text-success mb-1">₺0</div>
                                                        <small class="text-muted">/ay</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                {% if current_user.subscription_plan == 'free' %}
                                                    <a href="{{ url_for('main.pricing') }}" class="btn btn-primary">
                                                        <i class="fas fa-arrow-up me-2"></i>Planı Yükselt
                                                    </a>
                                                {% else %}
                                                    <div class="btn-group" role="group">
                                                        <a href="{{ url_for('main.pricing') }}" class="btn btn-outline-primary">
                                                            <i class="fas fa-arrow-up me-2"></i>Planı Değiştir
                                                        </a>
                                                        {% if current_user.subscription_status == 'active' %}
                                                            <button type="button" class="btn btn-outline-danger" id="cancelSubscription">
                                                                <i class="fas fa-times me-2"></i>Aboneliği İptal Et
                                                            </button>
                                                        {% elif current_user.subscription_status == 'cancelled' %}
                                                            <button type="button" class="btn btn-success" id="reactivateSubscription">
                                                                <i class="fas fa-play me-2"></i>Aboneliği Yeniden Başlat
                                                            </button>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Usage Statistics -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="fw-bold mb-3">Bu Ay Kullanım İstatistikleri</h6>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <div class="text-center">
                                                        <div class="h4 fw-bold text-primary mb-1">{{ current_user.monthly_searches or 0 }}</div>
                                                        <small class="text-muted">Arama Sayısı</small>
                                                        <div class="progress mt-2" style="height: 4px;">
                                                            <div class="progress-bar" role="progressbar" style="width: 0%" id="searchProgress"></div>
                                                        </div>
                                                        <small class="text-muted">{{ current_user.search_limit or 'Sınırsız' }} limitinden</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="text-center">
                                                        <div class="h4 fw-bold text-success mb-1">{{ current_user.monthly_api_calls or 0 }}</div>
                                                        <small class="text-muted">API Çağrısı</small>
                                                        <div class="progress mt-2" style="height: 4px;">
                                                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="apiProgress"></div>
                                                        </div>
                                                        <small class="text-muted">{{ current_user.api_limit or 'Sınırsız' }} limitinden</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="text-center">
                                                        <div class="h4 fw-bold text-warning mb-1">{{ current_user.monthly_exports or 0 }}</div>
                                                        <small class="text-muted">Dışa Aktarım</small>
                                                        <div class="progress mt-2" style="height: 4px;">
                                                            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="exportProgress"></div>
                                                        </div>
                                                        <small class="text-muted">{{ current_user.export_limit or 'Sınırsız' }} limitinden</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Billing History -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="fw-bold mb-0">Fatura Geçmişi</h6>
                                                <button type="button" class="btn btn-outline-primary btn-sm" id="downloadInvoices">
                                                    <i class="fas fa-download me-2"></i>Faturaları İndir
                                                </button>
                                            </div>
                                            
                                            <div id="billingHistory">
                                                <!-- Billing history will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- API Keys Tab -->
                        <div class="tab-pane fade" id="api" role="tabpanel">
                            <div class="row g-4">
                                <!-- API Keys List -->
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-bold mb-0">API Anahtarlarınız</h6>
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">
                                            <i class="fas fa-plus me-2"></i>Yeni API Anahtarı
                                        </button>
                                    </div>
                                    
                                    <div id="apiKeysList">
                                        <!-- API keys will be loaded here -->
                                    </div>
                                </div>
                                
                                <!-- API Documentation -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="fw-bold mb-3">API Kullanımı</h6>
                                            <p class="text-muted mb-3">
                                                API anahtarınızı kullanarak programatik olarak veri arama işlemleri gerçekleştirebilirsiniz.
                                            </p>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <h6 class="fw-medium">Temel Kullanım</h6>
                                                    <pre class="bg-dark text-light p-3 rounded"><code>curl -X GET "https://api.b2bveri.com/v1/search" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"query": "şirket adı", "limit": 10}'</code></pre>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="fw-medium">Yanıt Formatı</h6>
                                                    <pre class="bg-dark text-light p-3 rounded"><code>{
  "success": true,
  "data": [
    {
      "company_name": "Örnek Şirket",
      "phone": "+90 212 123 45 67",
      "email": "info@ornek.com"
    }
  ],
  "total": 1
}</code></pre>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <a href="/api/docs" target="_blank" class="btn btn-outline-primary">
                                                    <i class="fas fa-book me-2"></i>Detaylı API Dokümantasyonu
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notifications Tab -->
                        <div class="tab-pane fade" id="notifications" role="tabpanel">
                            <form id="notificationForm">
                                <div class="row g-4">
                                    <!-- Email Notifications -->
                                    <div class="col-12">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body">
                                                <h6 class="fw-bold mb-3">E-posta Bildirimleri</h6>
                                                
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="emailSearchAlerts" 
                                                                   {{ 'checked' if current_user.email_search_alerts else '' }}>
                                                            <label class="form-check-label" for="emailSearchAlerts">
                                                                <strong>Arama Uyarıları</strong><br>
                                                                <small class="text-muted">Yeni arama sonuçları için bildirim al</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="emailBilling" 
                                                                   {{ 'checked' if current_user.email_billing else '' }}>
                                                            <label class="form-check-label" for="emailBilling">
                                                                <strong>Fatura Bildirimleri</strong><br>
                                                                <small class="text-muted">Fatura ve ödeme bildirimleri</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="emailSecurity" 
                                                                   {{ 'checked' if current_user.email_security else '' }}>
                                                            <label class="form-check-label" for="emailSecurity">
                                                                <strong>Güvenlik Uyarıları</strong><br>
                                                                <small class="text-muted">Şüpheli giriş denemeleri ve güvenlik olayları</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="emailMarketing" 
                                                                   {{ 'checked' if current_user.email_marketing else '' }}>
                                                            <label class="form-check-label" for="emailMarketing">
                                                                <strong>Pazarlama E-postaları</strong><br>
                                                                <small class="text-muted">Yeni özellikler ve promosyonlar</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Browser Notifications -->
                                    <div class="col-12">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body">
                                                <h6 class="fw-bold mb-3">Tarayıcı Bildirimleri</h6>
                                                
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="browserNotifications" 
                                                                   {{ 'checked' if current_user.browser_notifications else '' }}>
                                                            <label class="form-check-label" for="browserNotifications">
                                                                <strong>Tarayıcı Bildirimleri</strong><br>
                                                                <small class="text-muted">Önemli güncellemeler için anlık bildirim</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="desktopNotifications" 
                                                                   {{ 'checked' if current_user.desktop_notifications else '' }}>
                                                            <label class="form-check-label" for="desktopNotifications">
                                                                <strong>Masaüstü Bildirimleri</strong><br>
                                                                <small class="text-muted">Sistem bildirimleri göster</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Bildirim Ayarlarını Kaydet
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Upload Modal -->
<div class="modal fade" id="avatarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Profil Fotoğrafı Değiştir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div id="avatarPreview" class="mb-3">
                        <img src="{{ current_user.avatar or '/static/img/default-avatar.png' }}" 
                             alt="Avatar" class="rounded-circle" width="120" height="120">
                    </div>
                    <input type="file" class="form-control" id="avatarFile" accept="image/*">
                    <div class="form-text">JPG, PNG veya GIF formatında, maksimum 2MB</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="uploadAvatar">
                    <i class="fas fa-upload me-2"></i>Yükle
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createApiKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni API Anahtarı Oluştur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createApiKeyForm">
                    <div class="mb-3">
                        <label for="apiKeyName" class="form-label">API Anahtarı Adı *</label>
                        <input type="text" class="form-control" id="apiKeyName" required 
                               placeholder="Örn: Mobil Uygulama, Web Sitesi">
                    </div>
                    <div class="mb-3">
                        <label for="apiKeyDescription" class="form-label">Açıklama</label>
                        <textarea class="form-control" id="apiKeyDescription" rows="2" 
                                  placeholder="Bu API anahtarının kullanım amacı..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="apiKeyPermissions" class="form-label">İzinler</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="permissionSearch" checked>
                            <label class="form-check-label" for="permissionSearch">Arama</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="permissionExport">
                            <label class="form-check-label" for="permissionExport">Dışa Aktarım</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="permissionStats">
                            <label class="form-check-label" for="permissionStats">İstatistikler</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="createApiKey">
                    <i class="fas fa-key me-2"></i>API Anahtarı Oluştur
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Load initial data
    loadSessions();
    loadBillingHistory();
    loadApiKeys();
    
    // Profile form submission
    $('#profileForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            name: $('#name').val(),
            email: $('#email').val(),
            phone: $('#phone').val(),
            company: $('#company').val(),
            title: $('#title').val(),
            industry: $('#industry').val(),
            bio: $('#bio').val()
        };
        
        $.ajax({
            url: '/auth/update-profile',
            method: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    showToast('Profil bilgileriniz güncellendi.', 'success');
                } else {
                    showToast('Hata: ' + response.message, 'error');
                }
            },
            error: function() {
                showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
            }
        });
    });
    
    // Password form submission
    $('#passwordForm').on('submit', function(e) {
        e.preventDefault();
        
        const newPassword = $('#newPassword').val();
        const confirmPassword = $('#confirmPassword').val();
        
        if (newPassword !== confirmPassword) {
            showToast('Yeni şifreler eşleşmiyor.', 'error');
            return;
        }
        
        const formData = {
            current_password: $('#currentPassword').val(),
            new_password: newPassword
        };
        
        $.ajax({
            url: '/auth/change-password',
            method: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    showToast('Şifreniz başarıyla değiştirildi.', 'success');
                    $('#passwordForm')[0].reset();
                } else {
                    showToast('Hata: ' + response.message, 'error');
                }
            },
            error: function() {
                showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
            }
        });
    });
    
    // Notification form submission
    $('#notificationForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            email_search_alerts: $('#emailSearchAlerts').is(':checked'),
            email_billing: $('#emailBilling').is(':checked'),
            email_security: $('#emailSecurity').is(':checked'),
            email_marketing: $('#emailMarketing').is(':checked'),
            browser_notifications: $('#browserNotifications').is(':checked'),
            desktop_notifications: $('#desktopNotifications').is(':checked')
        };
        
        $.ajax({
            url: '/auth/update-notifications',
            method: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    showToast('Bildirim ayarlarınız güncellendi.', 'success');
                } else {
                    showToast('Hata: ' + response.message, 'error');
                }
            },
            error: function() {
                showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
            }
        });
    });
    
    // Avatar upload
    $('#uploadAvatar').on('click', function() {
        const fileInput = $('#avatarFile')[0];
        if (!fileInput.files[0]) {
            showToast('Lütfen bir dosya seçin.', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('avatar', fileInput.files[0]);
        
        $.ajax({
            url: '/auth/upload-avatar',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    showToast('Profil fotoğrafınız güncellendi.', 'success');
                    location.reload();
                } else {
                    showToast('Hata: ' + response.message, 'error');
                }
            },
            error: function() {
                showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
            }
        });
    });
    
    // Create API key
    $('#createApiKey').on('click', function() {
        const formData = {
            name: $('#apiKeyName').val(),
            description: $('#apiKeyDescription').val(),
            permissions: {
                search: $('#permissionSearch').is(':checked'),
                export: $('#permissionExport').is(':checked'),
                stats: $('#permissionStats').is(':checked')
            }
        };
        
        $.ajax({
            url: '/api/create-key',
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    showToast('API anahtarı oluşturuldu.', 'success');
                    $('#createApiKeyModal').modal('hide');
                    loadApiKeys();
                } else {
                    showToast('Hata: ' + response.message, 'error');
                }
            },
            error: function() {
                showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
            }
        });
    });
});

// Load functions
function loadSessions() {
    $.get('/auth/sessions', function(data) {
        let html = '';
        data.sessions.forEach(function(session) {
            html += `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <div>
                        <div class="fw-medium">${session.device}</div>
                        <small class="text-muted">${session.location} • ${session.last_seen}</small>
                    </div>
                    <div>
                        ${session.current ? '<span class="badge bg-success">Mevcut</span>' : 
                          '<button class="btn btn-outline-danger btn-sm" onclick="terminateSession(\''+session.id+'\')">' +
                          '<i class="fas fa-times"></i></button>'}
                    </div>
                </div>
            `;
        });
        $('#sessionsList').html(html);
    });
}

function loadBillingHistory() {
    $.get('/payment/billing-history', function(data) {
        let html = '';
        if (data.invoices.length === 0) {
            html = '<p class="text-muted text-center">Henüz fatura geçmişiniz bulunmuyor.</p>';
        } else {
            data.invoices.forEach(function(invoice) {
                html += `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <div class="fw-medium">${invoice.description}</div>
                            <small class="text-muted">${invoice.date}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">₺${invoice.amount}</div>
                            <a href="${invoice.pdf_url}" class="btn btn-outline-primary btn-sm" target="_blank">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                `;
            });
        }
        $('#billingHistory').html(html);
    });
}

function loadApiKeys() {
    $.get('/api/keys', function(data) {
        let html = '';
        if (data.keys.length === 0) {
            html = '<p class="text-muted text-center">Henüz API anahtarınız bulunmuyor.</p>';
        } else {
            data.keys.forEach(function(key) {
                html += `
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="fw-bold mb-1">${key.name}</h6>
                                    <p class="text-muted mb-2">${key.description || 'Açıklama yok'}</p>
                                    <small class="text-muted">Oluşturulma: ${key.created_at}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${key.active ? 'success' : 'secondary'} mb-2">
                                        ${key.active ? 'Aktif' : 'Pasif'}
                                    </span><br>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="toggleApiKey('${key.id}')">
                                            <i class="fas fa-${key.active ? 'pause' : 'play'}"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteApiKey('${key.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="input-group">
                                    <input type="text" class="form-control font-monospace" value="${key.key}" readonly>
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('${key.key}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        $('#apiKeysList').html(html);
    });
}

// Utility functions
function terminateSession(sessionId) {
    if (confirm('Bu oturumu sonlandırmak istediğinizden emin misiniz?')) {
        $.ajax({
            url: '/auth/terminate-session',
            method: 'POST',
            data: { session_id: sessionId },
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    showToast('Oturum sonlandırıldı.', 'success');
                    loadSessions();
                } else {
                    showToast('Hata: ' + response.message, 'error');
                }
            }
        });
    }
}

function toggleApiKey(keyId) {
    $.ajax({
        url: '/api/toggle-key',
        method: 'POST',
        data: { key_id: keyId },
        headers: {
            'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
        },
        success: function(response) {
            if (response.success) {
                showToast('API anahtarı durumu güncellendi.', 'success');
                loadApiKeys();
            } else {
                showToast('Hata: ' + response.message, 'error');
            }
        }
    });
}

function deleteApiKey(keyId) {
    if (confirm('Bu API anahtarını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
        $.ajax({
            url: '/api/delete-key',
            method: 'DELETE',
            data: { key_id: keyId },
            headers: {
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            },
            success: function(response) {
                if (response.success) {
                    showToast('API anahtarı silindi.', 'success');
                    loadApiKeys();
                } else {
                    showToast('Hata: ' + response.message, 'error');
                }
            }
        });
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showToast('API anahtarı panoya kopyalandı.', 'success');
    });
}
</script>
{% endblock %}